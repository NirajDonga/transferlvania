name: Deploy to VM

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      # Build backend on GitHub
      - name: Build backend image
        run: |
          docker build -t transferlvania-backend:${{ github.sha }} ./server
          docker save transferlvania-backend:${{ github.sha }} > backend.tar
      
      # Build frontend on GitHub
      - name: Build frontend image
        run: |
          docker build -t transferlvania-frontend:${{ github.sha }} ./client
          docker save transferlvania-frontend:${{ github.sha }} > frontend.tar
      
      # Transfer images to VM
      - name: Copy images to VM
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          source: "backend.tar,frontend.tar"
          target: "/tmp/"
      
      # Deploy on VM
      - name: Deploy to VM
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            cd /home/azureuser/transferlvania
            git pull origin main
            
            # Load images built on GitHub
            docker load < /tmp/backend.tar
            docker load < /tmp/frontend.tar
            docker tag transferlvania-backend:${{ github.sha }} transferlvania-backend:latest
            docker tag transferlvania-frontend:${{ github.sha }} transferlvania-frontend:latest
            
            # Create .env
            cat > .env << EOF
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
            CLIENT_URL=${{ secrets.CLIENT_URL }}
            NEXT_PUBLIC_SERVER_URL=${{ secrets.NEXT_PUBLIC_SERVER_URL }}
            PORT=4000
            TURN_SECRET=${{ secrets.TURN_SECRET }}
            EOF
            
            # Deploy with pre-built images
            docker-compose down
            docker-compose up -d
            sleep 10
            docker-compose exec -T backend npx prisma migrate deploy
            
            # Cleanup
            rm /tmp/backend.tar /tmp/frontend.tar