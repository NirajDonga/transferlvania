name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            server/package-lock.json
            client/package-lock.json
      
      # Build Backend
      - name: Build Server
        working-directory: ./server
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          npm ci
          npx prisma generate
          npm run build
      
      # Build Frontend
      - name: Build Client
        working-directory: ./client
        env:
          NEXT_PUBLIC_SERVER_URL: ${{ secrets.NEXT_PUBLIC_SERVER_URL }}
        run: |
          npm ci
          npm run build
      
      # Package Application
      - name: Create Deployment Package
        run: |
          tar -czf deploy.tar.gz \
            server/dist \
            server/package*.json \
            server/prisma \
            server/Dockerfile \
            client/.next \
            client/package*.json \
            client/next.config.ts \
            client/Dockerfile \
            docker-compose.yml
      
      # Transfer to VM
      - name: Upload to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          source: "deploy.tar.gz"
          target: "/tmp/"
          strip_components: 0
          overwrite: true
          timeout: 60s
          command_timeout: 10m
          ssh_option: "-o StrictHostKeyChecking=no"
      
      # Deploy Application
      - name: Deploy Application
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 30m
          script_stop: true
          ssh_option: "-o StrictHostKeyChecking=no"
          script: |
            set -e
            
            # Setup deployment directory
            mkdir -p ~/transferlvania
            cd ~/transferlvania
            
            # Extract package
            tar -xzf /tmp/deploy.tar.gz
            rm /tmp/deploy.tar.gz
            
            # Create environment file
            cat > .env << 'EOF'
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
            CLIENT_URL=${{ secrets.CLIENT_URL }}
            NEXT_PUBLIC_SERVER_URL=${{ secrets.NEXT_PUBLIC_SERVER_URL }}
            TURN_SECRET=${{ secrets.TURN_SECRET }}
            NODE_ENV=production
            PORT=4000
            EOF
            
            # Deploy with Docker
            docker-compose down || true
            docker-compose up -d --build
            
            # Wait for services
            sleep 10
            
            # Run migrations
            docker-compose exec -T backend npx prisma migrate deploy
            
            # Show status
            docker-compose ps