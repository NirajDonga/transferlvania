name: Deploy to VM

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            server/package-lock.json
            client/package-lock.json
      
      - name: Build Backend
        working-directory: ./server
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Installing backend dependencies..."
          npm ci
          echo "Generating Prisma Client..."
          npx prisma generate
          echo "Building TypeScript..."
          npm run build
          echo "âœ… Backend build complete"
      
      - name: Build Frontend
        working-directory: ./client
        env:
          NEXT_PUBLIC_SERVER_URL: ${{ secrets.NEXT_PUBLIC_SERVER_URL }}
        run: |
          echo "Installing frontend dependencies..."
          npm ci
          echo "Building Next.js..."
          npm run build
          echo "âœ… Frontend build complete"
      
      - name: Package deployment files
        run: |
          echo "Packaging deployment artifacts..."
          tar -czf deploy.tar.gz \
            server/dist \
            server/package*.json \
            server/prisma \
            server/Dockerfile \
            client/.next \
            client/package*.json \
            client/next.config.ts \
            client/Dockerfile \
            docker-compose.yml
          echo "âœ… Package created: $(du -h deploy.tar.gz)"
      
      - name: Upload package to VM
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          source: "deploy.tar.gz"
          target: "/tmp/"
          timeout: 60s
          command_timeout: 10m
      
      - name: Deploy on VM
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 10m
          script: |
            set -e
            
            echo "ðŸ“¦ Setting up deployment directory..."
            mkdir -p ~/transferlvania
            cd ~/transferlvania
            
            echo "ðŸ“‚ Extracting deployment package..."
            tar -xzf /tmp/deploy.tar.gz
            rm /tmp/deploy.tar.gz
            
            echo "âš™ï¸  Creating environment configuration..."
            cat > .env << 'EOF'
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
            CLIENT_URL=${{ secrets.CLIENT_URL }}
            NEXT_PUBLIC_SERVER_URL=${{ secrets.NEXT_PUBLIC_SERVER_URL }}
            TURN_SECRET=${{ secrets.TURN_SECRET }}
            NODE_ENV=production
            PORT=4000
            EOF
            
            echo "ðŸ›‘ Stopping existing containers..."
            docker-compose down || true
            
            echo "ðŸ³ Building and starting containers..."
            docker-compose up -d --build
            
            echo "â³ Waiting for containers to start..."
            sleep 15
            
            echo "ðŸ—„ï¸  Running database migrations..."
            docker-compose exec -T backend npx prisma migrate deploy || echo "âš ï¸  Migration warning (may be expected)"
            
            echo ""
            echo "âœ… Deployment complete!"
            echo ""
            echo "ðŸ“Š Container status:"
            docker-compose ps
            
            echo ""
            echo "ðŸ“ Recent logs:"
            docker-compose logs --tail=50
            
            echo ""
            echo "ðŸ”— Services running at:"
            echo "   Frontend: http://${{ secrets.VM_HOST }}:3000"
            echo "   Backend:  http://${{ secrets.VM_HOST }}:4000"