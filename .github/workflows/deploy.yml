name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Get the code from GitHub
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Install Node.js version 20
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            server/package-lock.json
            client/package-lock.json
      
      # Step 3: Build the server (backend)
      - name: Build server
        working-directory: ./server
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          npm ci
          npx prisma generate
          npm run build
      
      # Step 4: Build the client (frontend)
      - name: Build client
        working-directory: ./client
        env:
          NEXT_PUBLIC_SERVER_URL: ${{ secrets.NEXT_PUBLIC_SERVER_URL }}
          NEXT_PUBLIC_CLIENT_URL: ${{ secrets.NEXT_PUBLIC_CLIENT_URL }}
        run: |
          npm ci
          npm run build
      
      # Step 5: Package everything into one file
      - name: Create package
        run: |
          tar -czf deploy.tar.gz \
            server/dist \
            server/package*.json \
            server/prisma \
            server/Dockerfile \
            client/.next \
            client/package*.json \
            client/next.config.ts \
            client/Dockerfile \
            docker-compose.yml \
            .env.example
      
      # Step 6: Copy package to your VM
      - name: Copy to VM
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          source: "deploy.tar.gz"
          target: "/tmp/"
      
      # Step 7: Deploy on VM
      - name: Deploy on VM
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          script: |
            # Go to app folder
            mkdir -p ~/transferlvania
            cd ~/transferlvania
            
            # Unpack the package
            tar -xzf /tmp/deploy.tar.gz
            rm /tmp/deploy.tar.gz
            
            # Create .env file with secrets
            cat > .env << EOF
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
            CLIENT_URL=${{ secrets.CLIENT_URL }}
            NEXT_PUBLIC_SERVER_URL=${{ secrets.NEXT_PUBLIC_SERVER_URL }}
            NEXT_PUBLIC_CLIENT_URL=${{ secrets.NEXT_PUBLIC_CLIENT_URL }}
            NODE_ENV=production
            PORT=4000
            EOF
            
            # Stop old containers
            docker compose down || true
            
            # Start new containers
            docker compose up -d --build
            
            # Wait for containers to start
            sleep 15
            
            # Update database
            docker compose exec -T backend npx prisma migrate deploy
            
            # Check if everything is running
            docker compose ps